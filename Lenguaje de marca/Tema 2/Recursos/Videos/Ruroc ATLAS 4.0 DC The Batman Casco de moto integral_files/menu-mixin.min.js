define(['ko','jquery','underscore','uiRegistry','mage/translate','Cookie','js/utils/navigation/get-height','scroll-direction','Magento_Checkout/js/view/minicart'],function(ko,$,_,registry,$t,Cookie,navigationHeightUtility,scrollDirectionUtility){'use strict';return function(target){$.widget('mage.menu',target.menu,{options:{mediaBreakpoint:'(max-width: 1023px)',cookieKey:'navigation-segment-id'},_create:function(){this._super();var self=this;this.minicart=registry.get('minicart_content');this.body=$('body');this.window=$(window);this.navigation=$('.navigation-wrapper');this.footer=this.navigation.find('.navigation-footer');this.currentSegment=this.getMenuSegment();this.currentSegmentItem=this.currentSegment.closest('.ui-menu-item');this.addSegmentMargin=this.addSegmentMargin.bind(this);this.setMenuHeight=this.setMenuHeight.bind(this);this.setMainMenuHeight=this.setMainMenuHeight.bind(this);this.sortExtraItems();this.openMenuSegment();this.addFixedAttributes();this.sortGroupItems();this.addAllLinks();this.scroll=ko.observable(this.window.scrollTop());this.window.on('scroll',function(){self.scroll(self.window.scrollTop());});this.shouldShow=ko.computed(function(){var direction=scrollDirectionUtility.direction();return(!direction||direction==='up')||self.scroll()<=navigationHeightUtility.getNavigationHeight()||(!!self.minicart?(self.minicart.isLoading()||self.minicart.isOpen()):null);});this.shouldShow.subscribe(this.toggleVisibility.bind(this));this.window.on('resize',function(){self.toggleVisibility(true);self.addPageMargin();});return this;},_toggleDesktopMode:function(){this.element.off('click mousedown mouseenter mouseleave');this.removeBackLinks();this.addBackLinks(1);this.unsetMainMenuHeight();this.unsetMenuHeight();this.unsetMenuOverflow();this.window.off('resize',this.setMainMenuHeight);this.window.off('resize',this.setMenuHeight);this.window.on('resize',this.addSegmentMargin);this.addSegmentMargin();this._on({'click .ui-menu-item:not(.parent)':function(event){var target=$(event.target).closest('.ui-menu-item'),link=target.find('> a').attr('href');event.preventDefault();event.stopPropagation();window.location.href=link;},'click .ui-menu-item.level0:has(.ui-state-active)':function(event){event.preventDefault();},'click .ui-menu-item.parent:not(.level0)':this.openDesktopMenu,'mouseenter .ui-menu-item.level1.parent':function(event){var target=$(event.target),targetIsMenu=target.hasClass('ui-menu'),isSecondLevelItem=target.closest('.ui-menu-item').hasClass('level1');if(targetIsMenu||!isSecondLevelItem){return;}
this.openDesktopMenu(event);},'mouseenter .ui-menu-item.level1:not(.parent)':this.collapseAll,'mouseleave .ui-menu.level0 > .ui-menu-item':this.collapseAll,'click .level1.submenu .ui-menu-item.parent':function(event){var item=$(event.target).closest('.ui-menu-item'),parentMenu=item.parents('.ui-menu').first(),submenu=item.find('> .ui-menu');event.preventDefault();event.stopPropagation();parentMenu.css({visibility:'hidden'});submenu.css({visibility:'visible'});},'click .back-link:has(a)':function(event){var target=$(event.target),item=target.closest('.ui-menu').closest('.ui-menu-item'),parentMenu=item.parents('.ui-menu').first(),link=item.find('> a');event.preventDefault();event.stopPropagation();this.updateMenuHoverEvents(parentMenu,false);this._close(item);parentMenu.css({visibility:'visible'});this._delay(function(){link.removeClass('ui-state-active ui-state-focus');});},'mouseenter .ui-menu':function(event){var target=$(event.currentTarget);target.closest('.ui-menu-item').find('> a').addClass('ui-state-active');},'click .ui-menu':function(event){event.stopPropagation();}});},openDesktopMenu:function(event){var item=$(event.target).closest('.ui-menu-item'),submenu=item.find('> .ui-menu'),parentItem=item.closest('.level1.ui-menu-item'),parentLink=parentItem.find('> a'),otherParentLinks=parentItem.siblings().find('> a');event.preventDefault();event.stopPropagation();parentLink.addClass('ui-state-active');otherParentLinks.removeClass('ui-state-active');this.updateMenuHoverEvents(submenu);this._open(submenu);},_toggleMobileMode:function(){var self=this;this.element.off('click mouseenter mouseleave');this.removeBackLinks();this.addBackLinks(0);this.setMainMenuHeight();this.setMenuHeight();this.element.css({marginBottom:0});this.window.off('resize',this.addSegmentMargin);this.window.on('resize',this.setMainMenuHeight);this.window.on('resize',this.setMenuHeight);this._on({'click .ui-menu-item:not(.parent), .ui-menu-item.level0 > a:not(.ui-state-active)':function(event){var target=$(event.target).closest('.ui-menu-item'),link=target.find('> a').attr('href');event.preventDefault();event.stopPropagation();window.location.href=link;},'click .ui-menu-item.level0:has(.ui-state-active)':function(event){event.preventDefault();},'click .ui-menu-item.parent':function(event){var target=$(event.target),item=target.closest('.ui-menu-item'),itemLink=item.find('> a'),isActive=itemLink.hasClass('ui-state-active'),submenu=item.find('> .ui-menu'),parentMenu=item.parents('.ui-menu').first(),isMainMenu=target.is(self.element.find('.level0.submenu')),isTopLevelItem=item.is(self.element.find('.level0'));event.preventDefault();event.stopPropagation();if(isMainMenu||isTopLevelItem){return;}
itemLink.toggleClass('ui-state-active',!isActive);this[!isActive?'_open':'_close'](!isActive?submenu:parentMenu);if(!isActive){parentMenu.scrollTop(0);parentMenu.css({overflow:'hidden'});}},'click .back-link:has(a)':function(event){var target=$(event.target),item=target.closest('.ui-menu').closest('.ui-menu-item'),parentMenu=item.parents('.ui-menu').first(),link=item.find('> a');event.preventDefault();event.stopPropagation();this._close(item);parentMenu.css({overflow:''});this._delay(function(){link.removeClass('ui-state-active ui-state-focus');});},'click .ui-menu':function(event){event.stopPropagation();}});},_listen:function(){this._super();this.controls.swipeArea.off('swipeleft');},collapseAll:function(event,all){this._super(event,all);this.updateMenuHoverEvents(null);this.openMenuSegment();},updateMenuHoverEvents:function(menu,waitForMouseEnter=true){var self=this,menus=this.element.find('.ui-menu');menus.off('mouseenter mouseleave');if(!!menu){menu.on(waitForMouseEnter?'mouseenter':'mouseleave',function(event){if(waitForMouseEnter){menu.on('mouseleave',function(event){self.handleHoverMenuToggle(menu,event,true);});}else{self.handleHoverMenuToggle(menu,event);}});}},handleHoverMenuToggle:function(menu,event,unbind=false){var secondLevelItem=menu.parents('.ui-menu-item.level1'),relatedTargetIsSecondLevelItem=$(event.relatedTarget).closest('.ui-menu-item').is(secondLevelItem);if(unbind){menu.off('mouseleave');}
relatedTargetIsSecondLevelItem?this._open(menu):this.collapseAll();},focus:function(){},getActiveItem:function(){return this.element.find('[data-is-active="1"]');},getActiveSegmentId:function(){return this.getActiveItem().data('top-category-id');},getActiveSegment:function(){return this.element.find('[data-category-id="'+this.getCurrentSegmentId()+'"]');},shouldSetCookie:function(){return!!this.getCurrentSegmentId();},setSegmentCookie:function(){Cookie.set(this.options.cookieKey,this.getCurrentSegmentId(),{expires:365*10});},getCurrentSegmentId:function(){var activeItemId=this.getActiveSegmentId(),storedItemId=Cookie.get(this.options.cookieKey),storedItemIsAvailable=!!this.element.find('[data-category-id="'+storedItemId+'"]').length;return!!activeItemId?activeItemId:storedItemIsAvailable?storedItemId:null;},getMenuSegment:function(){if(this.shouldSetCookie()){this.setSegmentCookie();}
return this.getActiveSegment().find('> .submenu');},openMenuSegment:function(){this.element.find('a').removeClass('ui-state-focus ui-state-active');this.currentSegmentItem.find('> a').addClass('ui-state-active');this.unsetMenuOverflow();this.unsetMenuVisibility();this._open(this.currentSegment);},addSegmentMargin:function(){var segmentHeight=this.currentSegment.outerHeight();this.element.css({marginBottom:segmentHeight});this.addPageMargin();},addPageMargin:function(){this.body.css({marginTop:navigationHeightUtility.getNavigationHeight()});},addFixedAttributes:function(){this.navigation.addClass('fixed');this.addPageMargin();},toggleVisibility:function(shouldShow){this.navigation.toggleClass('hide',!shouldShow);if(!shouldShow){this.collapseAll();}},setMenuHeight:function(){var tabHeight=this.element.outerHeight(),footerHeight=this.footer.outerHeight(),windowHeight=window.innerHeight,menu=this.element.find('.level0 .submenu');menu.css({height:windowHeight-(navigationHeightUtility.getNavigationHeight()+tabHeight+footerHeight)});},unsetMenuHeight:function(){var menu=this.element.find('.level0 .submenu');menu.css({height:''});},unsetMenuOverflow:function(){var menu=this.element.find('.level0 .submenu');menu.css({overflow:''});},setMainMenuHeight:function(){var sections=this.navigation.find('.nav-sections'),footerHeight=this.footer.outerHeight(),windowHeight=window.innerHeight;sections.css({height:windowHeight-(navigationHeightUtility.getNavigationHeight()+footerHeight)});},unsetMainMenuHeight:function(){var sections=this.navigation.find('.nav-sections');sections.css({height:''});},unsetMenuVisibility:function(){var menus=this.element.find('.ui-menu');menus.css({visibility:''});},createLink:function(text,classes='',link='#'){var itemElement=$('<li>'),itemAnchorElement=$('<a>'),itemNameElement=$('<span>');itemNameElement.text(text);if(!!link){itemAnchorElement.attr('href',link);itemAnchorElement.append(itemNameElement);itemElement.addClass('ui-menu-item');}
itemElement.append(!!link?itemAnchorElement:itemNameElement);itemElement.addClass(classes);return itemElement;},addBackLinks:function(level){var self=this,parentItems=this.element.find('.level'+level+' .parent');parentItems.each(function(){var parentItem=$(this),menu=parentItem.find('> .ui-menu');menu.prepend(self.createLink($t('Back'),'back-link'));});},removeBackLinks:function(){this.element.find('.back-link').remove();},addAllLinks:function(){var self=this,parentItems=this.element.find('.parent');parentItems.each(function(){var parentItem=$(this),menu=parentItem.find('> .ui-menu'),parentAnchor=parentItem.find('> a'),parentLink=parentAnchor.attr('href'),parentName=parentAnchor.text();menu.prepend(self.createLink(parentName,'all-link',parentLink));});},sortExtraItems:function(){var extraItems=this.navigation.find('.navigation-extra-items').children('li').toArray(),sortedExtraItems=_.groupBy(extraItems,function(item){return $(item).data('navigation-section');});delete sortedExtraItems.undefined;_.each(sortedExtraItems,function(sectionItems,sectionSelector){var menu=$(sectionSelector).find('> .ui-menu');_.each(sectionItems,function(sectionItem){var item=$(sectionItem),sortOrderItem=menu.children(':not(.all-link)').eq(item.data('navigation-sort'));!!sortOrderItem.length?sortOrderItem.before(item):menu.append(item);});});},sortGroupItems:function(){var self=this,menus=this.element.find('.level1 .ui-menu').toArray();menus=_.sortBy(menus,function(menu){var element=$(menu),regex=new RegExp('level([0-9]+)','g'),classes=element.attr('class');return parseInt(regex.exec(classes)[1]);});menus.reverse();for(var menu of menus){menu=$(menu);var menuItems=menu.children(),ungroupableItems=menuItems.filter(':not([data-navigation-groups])'),groupableItems=menuItems.filter('[data-navigation-groups]').toArray(),groups=[];for(var groupableItem of groupableItems){var itemGroups=$(groupableItem).data('navigation-groups').split(',');for(var itemGroup of itemGroups){groups.push(itemGroup.trim());}}
groups=_.uniq(groups);var groupedItems={};for(const group of groups){groupedItems[group]=menu.find('> [data-navigation-groups*="'+group+'"]').clone(true);}
groupedItems=_.map(groupedItems,function(items,group){return self.createGroup(items,group);});if(!!ungroupableItems.length){groupedItems.push(this.createGroup(ungroupableItems.clone(true)));}
menuItems.remove();menu.append(groupedItems);}},createGroup:function(items,group=null){var hasGroupName=!!group,groupElement=$('<li class="group'+(!hasGroupName?' ungrouped':'')+'">'+
(hasGroupName?('<div class="group-title">'+group+'</div>'):'')+'<ul class="group-items"></ul>'+'</li>'),groupElementMenu=groupElement.find('.group-items');var sortedItems=_.groupBy(items,function(item){return!!$(item).data('navigation-sort')?'extra':'regular';});var regularItems=sortedItems.regular;_.each(sortedItems.extra,function(extraItem){var item=$(extraItem),sortOrder=item.data('navigation-sort');regularItems.splice(sortOrder,0,extraItem);});groupElementMenu.append(regularItems);return groupElement;}});return $.mage.menu;}});